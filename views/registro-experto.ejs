<!DOCTYPE html>
<html lang="es">

<head>
  <!-- Metadatos y enlaces a recursos externos -->
  <meta charset="UTF-8" />
  <!-- Codificación de caracteres UTF-8 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Diseño responsivo para dispositivos móviles -->
  <title>Registro | Servitech</title>
  <!-- Título de la pestaña del navegador -->
  <link rel="stylesheet" href="/assets/css/auth.css" />
  <!-- Estilos específicos para autenticación -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Iconos de Font Awesome -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <!-- Fuente Inter para mejorar la tipografía -->
</head>

<body>

  <main class="registro-experto-main">
    <section class="registro-experto-section">
      <% if (typeof error !=='undefined' ) { %>
        <div class="alert alert-danger">
          <%= error %>
        </div>
        <% } %>
          <% if (typeof success !=='undefined' ) { %>
            <div class="alert alert-success">
              <%= success %><br>
                Serás redirigido a tu panel de experto en unos segundos...
            </div>
            <script>
              setTimeout(function () {
                window.location.href = '/perfil-experto';
              }, 3000);
            </script>
            <% } %>

              <div class="registro-header">
                <h1>Registro de Experto</h1>
                <p class="subtitle">Completa tu perfil para ofrecer asesorías</p>
              </div>

              <form id="registroExpertoForm" class="registro-experto-form">
                <!-- Información Básica -->
                <div class="form-row">
                  <div class="form-group compact">
                    <label for="email">Email registrado</label>
                    <input type="email" id="email" name="email" required placeholder="tucorreo@ejemplo.com"
                      value="<%= typeof email !== 'undefined' ? email : '' %>" readonly>
                    <p class="form-hint">Email de tu cuenta</p>
                  </div>

                  <div class="form-group compact">
                    <label for="especialidad">Especialidad</label>
                    <select id="especialidad" name="especialidad" required>
                      <option value="">Selecciona una especialidad</option>
                    </select>
                  </div>
                </div>

                <!-- Descripción -->
                <div class="form-group">
                  <label for="descripcion">Descripción profesional</label>
                  <textarea id="descripcion" name="descripcion" required rows="3"
                    placeholder="Tu experiencia y enfoque profesional"></textarea>
                </div>

                <!-- Áreas de Conocimiento -->
                <div class="form-row">
                  <div class="form-group compact">
                    <label for="categorias">Categorías</label>
                    <select id="categorias" name="categorias" multiple required style="min-height: 80px;">
                      <!-- Opciones dinámicas -->
                    </select>
                    <p class="form-hint">Selecciona una o varias categorías tecnológicas</p>
                  </div>

                  <div class="form-group compact">
                    <label for="skills">Habilidades</label>
                    <select id="skills" name="skills" multiple style="min-height: 80px;">
                      <!-- Opciones dinámicas -->
                    </select>
                    <input type="text" id="nuevaSkill"
                      placeholder="Agregar nueva habilidad tecnológica y presiona Enter">
                    <p class="form-hint">Selecciona o agrega habilidades tecnológicas</p>
                  </div>
                </div>

                <!-- Horarios Múltiples -->
                <div class="form-group">
                  <label>Disponibilidad Horaria</label>
                  <div id="horarios-container">
                    <!-- Primer horario -->
                    <div class="horario-item">
                      <div class="form-row">
                        <div class="form-group compact">
                          <label>Día</label>
                          <select name="horarios[0][dia]" required>
                            <option value="Lunes">Lunes</option>
                            <option value="Martes">Martes</option>
                            <option value="Miércoles">Miércoles</option>
                            <option value="Jueves">Jueves</option>
                            <option value="Viernes">Viernes</option>
                            <option value="Sábado">Sábado</option>
                            <option value="Domingo">Domingo</option>
                          </select>
                        </div>

                        <div class="form-group compact">
                          <label>Hora inicio</label>
                          <select name="horarios[0][inicio]" required>
                            <% for(let h=8; h <=20; h++) { %>
                              <option value="<%= h %>:00">
                                <%= h %>:00 <%= h < 12 ? 'AM' : 'PM' %>
                              </option>
                              <% if(h < 20) { %>
                                <option value="<%= h %>:30">
                                  <%= h %>:30 <%= h < 12 ? 'AM' : 'PM' %>
                                </option>
                                <% } %>
                                  <% } %>
                          </select>
                        </div>

                        <div class="form-group compact">
                          <label>Hora fin</label>
                          <select name="horarios[0][fin]" required>
                            <% for(let h=9; h <=21; h++) { %>
                              <option value="<%= h %>:00">
                                <%= h %>:00 <%= h < 12 ? 'AM' : 'PM' %>
                              </option>
                              <% if(h < 21) { %>
                                <option value="<%= h %>:30">
                                  <%= h %>:30 <%= h < 12 ? 'AM' : 'PM' %>
                                </option>
                                <% } %>
                                  <% } %>
                          </select>
                        </div>

                        <div class="form-group compact">
                          <label>&nbsp;</label>
                          <button type="button" class="btn-remove-horario" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                              xmlns="http://www.w3.org/2000/svg">
                              <path d="M6 18L18 6M6 6L18 18" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <button type="button" id="add-horario" class="btn-add-horario">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                    </svg>
                    Añadir otro horario
                  </button>
                </div>

                <!-- Tarifas -->
                <div class="form-row">
                  <div class="form-group compact">
                    <label for="precio">Precio por hora (USD)</label>
                    <div class="price-input">
                      <span class="currency">$</span>
                      <input type="number" id="precio" name="precio" min="0" step="0.01" required placeholder="0.00">
                    </div>
                  </div>

                  <div class="form-group compact">
                    <label for="datosBancarios">Datos bancarios</label>
                    <input type="text" id="datosBancarios" name="datosBancarios" placeholder="Información para pagos">
                  </div>
                </div>

                <!-- Botón de envío -->
                <div class="form-footer">
                  <button type="button" id="submitExperto" class="btn btn-primary">
                    <span>Enviar solicitud</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                  </button>
                </div>
                <script>
                  document.addEventListener('DOMContentLoaded', async function () {
                    // Poblar especialidades
                    const especialidadSelect = document.getElementById('especialidad');
                    fetch('/api/especialidades')
                      .then(res => res.json())
                      .then(data => {
                        data.forEach(e => {
                          const opt = document.createElement('option');
                          opt.value = e.nombre;
                          opt.textContent = e.nombre;
                          especialidadSelect.appendChild(opt);
                        });
                      });

                    // Poblar categorías
                    const categoriasSelect = document.getElementById('categorias');
                    fetch('/api/categorias')
                      .then(res => res.json())
                      .then(data => {
                        data.forEach(c => {
                          const opt = document.createElement('option');
                          opt.value = c.nombre;
                          opt.textContent = c.nombre;
                          categoriasSelect.appendChild(opt);
                        });
                      });

                    // Poblar habilidades sugeridas (de expertos existentes)
                    const skillsSelect = document.getElementById('skills');
                    fetch('/api/skills')
                      .then(res => res.json())
                      .then(data => {
                        data.forEach(skill => {
                          const opt = document.createElement('option');
                          opt.value = skill.nombre;
                          opt.textContent = skill.nombre;
                          skillsSelect.appendChild(opt);
                        });
                      });

                    // Permitir agregar nuevas habilidades
                    const nuevaSkillInput = document.getElementById('nuevaSkill');
                    nuevaSkillInput.addEventListener('keydown', function (e) {
                      if (e.key === 'Enter' && this.value.trim()) {
                        e.preventDefault();
                        const val = this.value.trim();
                        let exists = false;
                        Array.from(skillsSelect.options).forEach(opt => {
                          if (opt.value.toLowerCase() === val.toLowerCase()) exists = true;
                        });
                        if (!exists) {
                          const opt = document.createElement('option');
                          opt.value = val;
                          opt.textContent = val;
                          opt.selected = true;
                          skillsSelect.appendChild(opt);
                        } else {
                          // Si ya existe, solo selecciona
                          Array.from(skillsSelect.options).forEach(opt => {
                            if (opt.value.toLowerCase() === val.toLowerCase()) opt.selected = true;
                          });
                        }
                        this.value = '';
                      }
                    });

                    // Envío del formulario
                    const form = document.getElementById('registroExpertoForm');
                    const submitBtn = document.getElementById('submitExperto');
                    if (form && submitBtn) {
                      submitBtn.addEventListener('click', async function () {
                        // Convertir selects múltiples a string separados por coma
                        Array.from(categoriasSelect.options).forEach(opt => {
                          if (opt.selected) opt.setAttribute('selected', 'selected');
                          else opt.removeAttribute('selected');
                        });
                        Array.from(skillsSelect.options).forEach(opt => {
                          if (opt.selected) opt.setAttribute('selected', 'selected');
                          else opt.removeAttribute('selected');
                        });
                        const formData = new FormData(form);
                        // Unir seleccionados en string para backend legacy
                        formData.set('categorias', Array.from(categoriasSelect.selectedOptions).map(o => o.value).join(','));
                        formData.set('skills', Array.from(skillsSelect.selectedOptions).map(o => o.value).join(','));
                        try {
                          const response = await fetch('/registro-experto', {
                            method: 'POST',
                            body: formData,
                            credentials: 'include'
                          });
                          if (response.redirected) {
                            window.location.href = response.url;
                          } else {
                            const result = await response.text();
                            document.open();
                            document.write(result);
                            document.close();
                          }
                        } catch (error) {
                          alert('Error al enviar el formulario: ' + error.message);
                        }
                      });
                    }
                  });
                </script>
              </form>
    </section>
  </main>

  <!-- Template para nuevos horarios (hidden) -->
  <template id="horario-template">
    <div class="horario-item">
      <div class="form-row">
        <div class="form-group compact">
          <label>Día</label>
          <select name="horarios[{{index}}][dia]" required>
            <option value="Lunes">Lunes</option>
            <option value="Martes">Martes</option>
            <option value="Miércoles">Miércoles</option>
            <option value="Jueves">Jueves</option>
            <option value="Viernes">Viernes</option>
            <option value="Sábado">Sábado</option>
            <option value="Domingo">Domingo</option>
          </select>
        </div>

        <div class="form-group compact">
          <label>Hora inicio</label>
          <select name="horarios[{{index}}][inicio]" required>
            <% for(let h=8; h <=20; h++) { %>
              <option value="<%= h %>:00">
                <%= h %>:00 <%= h < 12 ? 'AM' : 'PM' %>
              </option>
              <% if(h < 20) { %>
                <option value="<%= h %>:30">
                  <%= h %>:30 <%= h < 12 ? 'AM' : 'PM' %>
                </option>
                <% } %>
                  <% } %>
          </select>
        </div>

        <div class="form-group compact">
          <label>Hora fin</label>
          <select name="horarios[{{index}}][fin]" required>
            <% for(let h=9; h <=21; h++) { %>
              <option value="<%= h %>:00">
                <%= h %>:00 <%= h < 12 ? 'AM' : 'PM' %>
              </option>
              <% if(h < 21) { %>
                <option value="<%= h %>:30">
                  <%= h %>:30 <%= h < 12 ? 'AM' : 'PM' %>
                </option>
                <% } %>
                  <% } %>
          </select>
        </div>

        <div class="form-group compact">
          <label>&nbsp;</label>
          <button type="button" class="btn-remove-horario">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 18L18 6M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </template>


  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const container = document.getElementById('horarios-container');
      const addButton = document.getElementById('add-horario');
      const template = document.getElementById('horario-template').innerHTML;
      let horarioCount = 1;

      // Añadir nuevo horario
      addButton.addEventListener('click', function () {
        const newHorario = template.replace(/\{\{index\}\}/g, horarioCount);
        const div = document.createElement('div');
        div.innerHTML = newHorario;
        container.appendChild(div.firstElementChild);
        horarioCount++;
        // Habilitar botones de eliminar en todos menos el primero
        document.querySelectorAll('.btn-remove-horario').forEach((btn, index) => {
          btn.disabled = index === 0;
        });
      });

      // Eliminar horario
      container.addEventListener('click', function (e) {
        if (e.target.closest('.btn-remove-horario')) {
          const item = e.target.closest('.horario-item');
          item.remove();
          // Si solo queda uno, deshabilitar su botón de eliminar
          const removeButtons = document.querySelectorAll('.btn-remove-horario');
          if (removeButtons.length === 1) {
            removeButtons[0].disabled = true;
          }
        }
      });

      // Validación de horas (opcional)
      container.addEventListener('change', function (e) {
        if (e.target.name && e.target.name.includes('[inicio]')) {
          const inicioSelect = e.target;
          const finSelect = inicioSelect.closest('.form-row').querySelector('select[name$="[fin]"]');
          const inicioValue = inicioSelect.value;
          Array.from(finSelect.options).forEach(option => {
            option.disabled = option.value && option.value <= inicioValue;
          });
          if (finSelect.value && finSelect.value <= inicioValue) {
            finSelect.value = '';
          }
        }
      });
    });
  </script>

</body>

</html>
